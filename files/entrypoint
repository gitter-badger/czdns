#!/bin/sh

case "$USE_LIST" in
	chn)
		if [ -n "$CHINA_DNS0" ]; then
			sed -e "s|^\(server.*\)/[^/]*$|\1/$CHINA_DNS0|" /etc/czdns/china.conf >/etc/dnsmasq.d/china0.conf
			if [ -n "$CHINA_DNS1" ]; then
				sed -e "s|^\(server.*\)/[^/]*$|\1/$CHINA_DNS1|" /etc/czdns/china.conf >/etc/dnsmasq.d/china1.conf
			fi
		fi

		if [ -n "$OTHER_DNS0" ]; then
			echo "server=$OTHER_DNS0" >/etc/dnsmasq.d/others.conf
			if [ -n "$OTHER_DNS1" ]; then
				echo "server=$OTHER_DNS1" >>/etc/dnsmasq.d/others.conf
			fi
		fi
		;;
	gfw)
		if [ -n "$CHINA_DNS0" ]; then
			echo "server=$CHINA_DNS0" >/etc/dnsmasq.d/others.conf
			sed -n -e "s|^\(server.*\)/not_in_gfw$|\1/$CHINA_DNS0|p" /etc/czdns/gfwlist.conf >/etc/dnsmasq.d/gfwlist.not.0.conf
			if [ -n "$CHINA_DNS1" ]; then
				echo "server=$CHINA_DNS1" >>/etc/dnsmasq.d/others.conf
				sed -n -e "s|^\(server.*\)/not_in_gfw$|\1/$CHINA_DNS1|p" /etc/czdns/gfwlist.conf >/etc/dnsmasq.d/gfwlist.not.1.conf
			fi
		fi
		if [ -n "$OTHER_DNS0" ]; then
			sed -n -e "s|^\(server.*\)/in_gfw$|\1/$OTHER_DNS0|p" /etc/czdns/gfwlist.conf >/etc/dnsmasq.d/gfwlist0.conf
			if [ -n "$OTHER_DNS1" ]; then
				sed -n -e "s|^\(server.*\)/in_gfw$|\1/$OTHER_DNS1|p" /etc/czdns/gfwlist.conf >/etc/dnsmasq.d/gfwlist1.conf
			fi
		fi
		;;
	*)
		echo "unknown USE_LIST value: $USE_LIST, expecting chn, gfw" >&2
		exit 1
		;;
esac

# dnsmasq will close till _SC_OPEN_MAX
ulimit -n 1024
exec dnsmasq "$@"
